// Generated by CoffeeScript 1.6.1
(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d=[].slice,v={}.hasOwnProperty,m=function(e,t){function r(){this.constructor=e}for(var n in t)v.call(t,n)&&(e[n]=t[n]);r.prototype=t.prototype;e.prototype=new r;e.__super__=t.prototype;return e};n=function(){var e;e=1<=arguments.length?d.call(arguments,0):[];return console.log.apply(console,e)};u=function(e,t){var n,r,i,s,o,u,a;a="";n="";r="";if(e<0){n=" הכנסה של";r="";e=-e}if(e>=1e12){a=" trillion";e/=1e12;t=2}else if(e>=1e9){a=" מיליארד";e/=1e9;t=1}else if(e>=1e6){a=" מיליון";e/=1e6;t=1}s="";if(t>0){e<1&&(s="0");u=String(Math.round(e*Math.pow(10,t)));if(u<10){o="0"+u.substr(u.length-t,t);i=""}else{o=u.substr(u.length-t,t);i=u.substr(0,u.length-t)}return n+s+i.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")+"."+o+a+r}u=String(Math.round(e));u=u.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,");return n+u+a+r};t=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}m(t,e);t.prototype.defaults={data:[],field:"",title:"?"};t.prototype.initialize=function(){return this.on("change:field",function(){var e,t;t=this.get("field");e=budget_array_data[t];if(e){n("setting field "+t+" title: "+e.t);this.set("title",e.t);this.set("breadcrumbs",e.b);return this.set("data",e.d)}return n("field "+t+" is "+e)})};return t}(Backbone.Model);f=null;e=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}m(t,e);t.prototype.getFillColor=function(e){var t;t=d3.scale.ordinal().domain([-3,-2,-1,0,1,2,3]).range(["#dbae00","#eac865","#f5dd9c","#AAA","#bfc3dc","#9ea5c8","#7b82c2"]);return e.isNegative?"#fff":t(e.changeCategory)};t.prototype.getStrokeColor=function(e){var t;if(e.name===f)return"#FF0";t=d3.scale.ordinal().domain([-3,-2,-1,0,1,2,3]).range(["#c09100","#e7bd53","#d9c292","#999","#a7aed3","#7f8ab8","#4f5fb0"]);return t(e.changeCategory)};t.prototype.strokeWidth=function(e){return e.name===f?5:1};t.prototype.pctFormat=function(e){var t;t=d3.format(".1%");return e===Infinity||e===-Infinity?"N.A":t(e)};t.prototype.defaultCharge=function(e){return e.value<0?0:-Math.pow(e.radius,2)/8};t.prototype.totalSort=function(e){var t=this;return function(n){var r,i;i=0;r=0;n.isNegative&&(n.changeCategory>0?n.x=-200:n.x=1100);n.y=n.y+(i-n.y)*(t.defaultGravity+.02)*e;return n.x=n.x+(r-n.x)*(t.defaultGravity+.02)*e}};t.prototype.buoyancy=function(e){var t=this;return function(n){var r;r=-(n.changeCategory/3)*t.boundingRadius;return n.y=n.y+(r-n.y)*t.defaultGravity*e*e*e*500}};t.prototype.categorizeChange=function(e){return isNaN(e)?0:e<-0.25?-3:e<-0.05?-2:e<-0.001?-1:e<=.001?0:e<=.05?1:e<=.25?2:3};t.prototype.setOverlayed=function(e){e=e?!0:!1;return e?this.transitiontime=0:this.transitiontime=1e3};t.prototype.initialize=function(e){var t=this;this.options=e;_.bindAll(this);this.width=970;this.height=550;this.id=this.options.id;this.overlayShown=!1;n("BubbleChart:initialize",this.id);this.defaultGravity=.1;this.force=this.svg=this.circle=null;this.changeTickValues=[-0.25,-0.15,-0.05,.05,.15,.25];this.centerX=this.width/2;this.centerY=this.height/2;this.model.bind("change:data",function(){return t.updateData(t.model.get("data"))});d3.select(this.el).html("");this.svg=d3.select(this.el).append("svg:svg");this.svg.on("click",function(){c();return!1});return n("init done",this.id)};t.prototype.collectTitles=function(e,t,n,r){var i,s,o,u,a,f,l,c;n==null&&(n="");r==null&&(r=[]);if(!t)return;s=budget_array_data[t];if(s){l=s.d;c=[];for(a=0,f=l.length;a<f;a++){o=l[a];i=strings[o.id];u=strings[o.n];u&&i&&e.push({id:u,text:n+u,code:i,state:r});c.push(this.collectTitles(e,o.d,n+u+" | ",r.concat([o.d])))}return c}};t.prototype.updateData=function(e){var t,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S;o=[];h=0;for(d=0,y=e.length;d<y;d++){p=e[d];h+=p.b1}this.totalValue=h!=null?h:4e8;n("Totalvalue: "+this.totalValue);if(typeof this!="undefined"&&this!==null?this.nodes:void 0){S=this.nodes;for(v=0,b=S.length;v<b;v++){s=S[v];o.push(s)}}this.nodes=[];this.titles=[];this.collectTitles(this.titles,this.model.get("field"));f=d3.scale.pow().exponent(.5).domain([0,this.totalValue]).range([10,180]);l=function(e){return f(Math.abs(e))};this.boundingRadius=l(this.totalValue);r="b1";a="b0";for(m=0,w=e.length;m<w;m++){i=e[m];u=null;c=i.id;for(g=0,E=o.length;g<E;g++){s=o[g];s.sid===c&&(u=s)}u===null&&(u={x:-150+Math.random()*300,y:-150+Math.random()*300});u.sid=i.id;u.code=strings[i.id];u.radius=l(i[r]);u.group=strings[i.p];u.groupvalue=i.pv;u.change=i.c/100;u.changeCategory=this.categorizeChange(i.c/100);u.value=i[r];u.name=strings[i.n];u.isNegative=i[r]<0;u.positions=i.positions;u.drilldown=i.d;if(i[r]>0&&i[a]<0){u.changestr="הפך מהכנסה להוצאה";u.changeCategory=3}if(i[r]<0&&i[a]>0){u.changestr="הפך מהוצאה להכנסה";u.changeCategory=3}if(i.c===99999){u.changestr="תוקצב מחדש";u.changeCategory=3}this.nodes.push(u)}this.nodes.sort(function(e,t){return Math.abs(t.value)-Math.abs(e.value)});this.titles.sort(function(e,t){return e.code>t.code?1:-1});if(e.length>0)return this.render();t=$("div[data-id='"+this.id+"']");if(this.transitiontime>0){this.circle.transition().duration(this.transitiontime).attr("r",function(e){return 0});return t.find(".overlay").css("opacity",.9).animate({opacity:0},this.transitiontime,function(){return t.remove()})}return t.remove()};t.prototype.showOverlay=function(e){var t,r,i,s,o,u,a,f;if(this.overlayShown)return;this.overlayShown=!0;t=null;f=this.nodes;for(o=0,u=f.length;o<u;o++){a=f[o];a.drilldown===e&&(t=a)}if(t===null)return;i=this.height/t.radius/3;n("showOverlay: ",t.radius,this.height,i);r="translate("+this.centerX+","+this.centerY+")rotate(0)translate(1,1)scale(1)";s="translate("+this.centerX+","+this.centerY+")rotate(120)translate("+ -t.x*i+","+ -t.y*i+")scale("+i+")";if(this.transitiontime===0)this.svg.selectAll("circle").attr("transform",s);else{this.svg.selectAll("circle").transition().duration(this.transitiontime).attrTween("transform",function(){return d3.interpolateString(r,s)});n("TRANSITION "+r+" -> "+s)}return $("#tooltip").hide()};t.prototype.overlayRemoved=function(){var e,t;this.setOverlayed(!1);this.overlayShown=!1;e=this.svg.select("circle").attr("transform");t="translate("+this.centerX+","+this.centerY+")rotate(0)translate(1,1)scale(1)";this.svg.selectAll("circle").transition().duration(this.transitiontime).attrTween("transform",function(){return d3.interpolateString(e,t)});return this.circle.attr("r",function(e){return e.radius})};t.prototype.selectItem=function(e){f=e;this.circle.style("stroke-width",this.strokeWidth);return this.circle.style("stroke",this.getStrokeColor)};t.prototype.render=function(){var e,t,i,s,o,f,l,c,h=this;c=this;$("div[data-id='"+this.id+"'] .btnDownload").attr("href","/images/large/"+this.model.get("field")+".jpg");$("div[data-id='"+this.id+"'] .breadcrumbs").append("תקציב "+this.model.get("breadcrumbs")+"<br/>&nbsp;");o=$("div[data-id='"+this.id+"'] .mysearch");$("div[data-id='"+this.id+"'] .mysearch-open").click(function(){o.select2("open");return!1});o.select2({placeholder:"חפשו סעיף ספציפי",allowClear:!0,data:this.titles});o.on("select2-open",function(e){return $("div[data-id='"+c.id+"'] .breadcrumbs").css("visibility","hidden")}).on("select2-close",function(e){return $("div[data-id='"+c.id+"'] .breadcrumbs").css("visibility","visible")}).on("select2-highlight",function(e){return c.selectItem(e.choice.id)}).on("change",function(e){var t,i,s,u;n("changed:",e);if(e.added){c.selectItem(e.added.id);u=e.added.state;for(i=0,s=u.length;i<s;i++){t=u[i];r(t)}return o.select2("val","")}return c.selectItem(null)});l=$("div[data-id='"+this.id+"'] .tag");f=!1;l.mouseenter(function(){c.selectItem($(this).text());return f=!1}).mouseleave(function(){if(!f)return c.selectItem(null)}).click(function(){c.selectItem($(this).text());f=!0;return!1});e=$("div[data-id='"+this.id+"'] .overlayContainer");i=$("div[data-id='"+this.id+"'] .overlay");t=$("div[data-id='"+this.id+"'] .frame");s=function(){n("frame resize");h.width=$(window).width()-8;h.width>900&&(h.width=900);h.centerX=h.width/2+4;h.svg.attr("width",h.width);h.svg.style("width",h.width+"px");!h.overlayShown&&h.circle&&h.circle.attr("transform","translate("+h.centerX+","+h.centerY+")rotate(0)translate(0,0)scale(1)");return i.css("height",t.height()+8+"px")};$(window).resize(s);s();this.transitiontime>0?i.css("opacity",0).animate({opacity:.9},this.transitiontime):i.css("opacity",.9);this.circle=this.svg.selectAll("circle").data(this.nodes,function(e){return e.sid});c=this;this.circle.enter().append("svg:circle").attr("transform","translate("+this.centerX+","+this.centerY+")rotate(0)translate(0,0)scale(1)").attr("data-title",function(e){return e.name}).style("stroke-width",this.strokeWidth).style("fill",this.getFillColor).style("stroke",this.getStrokeColor).style("cursor",function(e){return budget_array_data[e.drilldown]?"pointer":"default"}).on("click",function(e,t){budget_array_data[e.drilldown]&&r(e.drilldown);d3.event.stopPropagation();return!1}).on("mouseover",function(e,t){var n,r,i,s,o,f;n=d3.select(this);i=$(c.el).find("svg").offset();o=Number(n.attr("cx"))+c.centerX;s=100;if(o<125){s+=125-o;o=125}if(o>c.width-125){s-=o-(c.width-125);o=c.width-125}o+=i.left;f=Number(n.attr("cy"));if(f>0){f=f-e.radius-10+i.top+c.centerY;$("#tooltipContainer").css("bottom",0);d3.select("#tooltip .arrow.top").style("display","none");d3.select("#tooltip .arrow.bottom").style("display","block")}else{f=f+e.radius+10+i.top+c.centerY;$("#tooltipContainer").css("bottom","");d3.select("#tooltip .arrow.top").style("display","block");d3.select("#tooltip .arrow.bottom").style("display","none")}e.drilldown&&n.style("stroke","#000").style("stroke-width",3);d3.select("#tooltip").style("top",f+"px").style("left",o+"px").style("display","block").classed("plus",e.changeCategory>0).classed("minus",e.changeCategory<0);d3.select("#tooltip .name").html(e.name);d3.select("#tooltip .department").text(e.group);d3.select("#tooltip .explanation").text(a(e.code,2012));d3.select("#tooltip .history").text("Hello there");d3.select("#tooltip .value").html(u(e.value*1e3)+" ₪");d3.selectAll("#tooltip .arrow").style("right",s+"px");if(e!=null?e.changestr:void 0)r=e.changestr;else{r=e.change==="N.A."?"N.A":c.pctFormat(Math.abs(e.change));r+=e.change<0?"-":"+"}return d3.select("#tooltip .change").html(r)}).on("mouseout",function(e,t){d3.select(this).style("stroke-width",c.strokeWidth).style("stroke",function(e){return c.getStrokeColor(e)});return d3.select("#tooltip").style("display","none")});if(this.transitiontime>0){this.circle.transition().duration(this.transitiontime).attr("r",function(e){return e.radius}).style("fill",function(e){return h.getFillColor(e)}).style("stroke",function(e){return h.getStrokeColor(e)});this.circle.exit().transition().duration(this.transitiontime).attr("r",function(e){return 0}).remove()}else{this.circle.attr("r",function(e){return e.radius}).style("fill",function(e){return h.getFillColor(e)}).style("stroke",function(e){return h.getStrokeColor(e)});this.circle.exit().remove()}this.force!==null&&this.force.stop();return this.force=d3.layout.force().nodes(this.nodes).size([this.width,this.height]).gravity(-0.01).charge(this.defaultCharge).friction(.9).on("tick",function(e){var t,n,r,i;n=0;r=0;t=0;i=h.nodes.length;return h.circle.each(h.totalSort(e.alpha)).each(h.buoyancy(e.alpha)).each(function(e){var i,s;i=e.x+e.radius;n=i>n?i:n;s=e.x-e.radius;r=s<r?s:r;return t=(n+r)/2}).attr("cx",function(e){return e.x-t}).attr("cy",function(e){return e.y})}).start()};return t}(Backbone.View);h={querys:[],selectedStory:null};i=[];o=!0;r=function(e){h.querys.push(e);return History.pushState(h,null,"?"+h.querys.join("/"))};c=function(){if(h.querys.length>1){h.querys.pop();return History.pushState(h,null,"?"+h.querys.join("/"))}};l=function(){var r,s,u,a,f,l,c,p,d,v,m,g,y,b,w,E;h=History.getState();h=h.data;n("state changed: ",h);for(s=m=0,y=h.querys.length;0<=y?m<y:m>y;s=0<=y?++m:--m){c=h.querys[s];f=h.querys[s+1];u="id"+s;r=$("div[data-id='"+u+"'] .chart");if(r.size()===0){n("creating chart "+u);v=((b=h.selectedStory)!=null?b.title:void 0)||"שינויי תכנון תקציב 2012 מול 2011";p=((w=h.selectedStory)!=null?w.subtitle:void 0)||"";d=_.template($("#chart-template").html(),{id:u,title:v,subtitle:p});$("#charts").append(d);r=$("div[data-id='"+u+"'] .chart");n("creating BubbleChart "+u);i[s]=new e({el:r,model:new t,id:u})}}a=h.querys.length>i.length?h.querys.length:i.length;n("max: "+a);for(s=g=E=a-1;E<=0?g<=0:g>=0;s=E<=0?++g:--g){n("setting field for "+s);if(s>=h.querys.length){n("removing chart #"+s);i[s].updateData([]);i.pop();continue}c=h.querys[s];l=!1;if(s<h.querys.length-2||o&&s<h.querys.length-1)l=!0;i[s].setOverlayed(l);i[s].model.set("field",c);s<h.querys.length-1&&i[s].showOverlay(h.querys[s+1])}if(a>h.querys.length&&i.length>0){n("chart "+(i.length-1)+": overlay removed");i[i.length-1].overlayRemoved()}o=!1;return $(".btnBack:first").css("display","none")};s={};a=function(e,t){var r,i;i=s[e];n("got years ",i);if(i){t=parseInt(t);r=i[t];r||(r=i[Object.keys(i)[0]]);return r}return null};window.handleExplanations=function(e){var t,r,i,o,u,a,f,l,c,h,p,d,v,m;u=1;t=null;o=null;l=null;v=e.feed.entry;for(c=0,p=v.length;c<p;c++){i=v[c];a=i.title.$t;a.search(/B[0-9]+/)===0&&(t=i.content.$t);a.search(/D[0-9]+/)===0&&(o=i.content.$t);if(a.search(/F[0-9]+/)===0){l=i.content.$t;l=l.split(",");if(t!==null&&o!==null)for(h=0,d=l.length;h<d;h++){m=l[h];f=parseInt(m);r=s[t];r||(s[t]={});s[t][f]=o}t=o=null}}return n(s)};p={};window.handleStories=function(e){var t,r,i,s,o,u,a,f,d,v,m,g,y,b,w;a=1;r=null;d=null;f=null;t=null;y=e.feed.entry;for(m=0,g=y.length;m<g;m++){i=y[m];o=i.title.$t;o.search(/B[0-9]+/)===0&&(r=i.content.$t);o.search(/C[0-9]+/)===0&&(d=i.content.$t);o.search(/D[0-9]+/)===0&&(f=i.content.$t);if(o.search(/G[0-9]+/)===0){t=i.content.$t;p[t]={code:r,title:d,subtitle:f};r=d=f=t=null}}n(p);History.Adapter.bind(window,"statechange",l);s="plpsq1";u=window.location.search.slice(1);if(u.length===0){u=window.location.hash;n("using hash: "+u);if(u.length>0){u=s.split("?");if(u.length>1){s=u[1];n("got state (hash): "+s)}}}else{s=u;n("got state (search): "+s)}if(p[s]){h.selectedStory=p[s];s=h.selectedStory.code;n("Selected story ("+h.selectedStory.code+")! "+h.selectedStory.title+", "+h.selectedStory.subtitle)}h.querys=s.split("/");n("Q",h.querys);if(h.querys.length===1)while(budget_array_data[h.querys[0]]){v=budget_array_data[h.querys[0]].u;if(!v)break;h.querys.unshift(v)}w=History.getState();n("getState: ",w);if(((b=w.data)!=null?b.querys:void 0)&&w.data.querys.length>0)l();else{n("xxx",w.data);History.replaceState(h,null,"?"+h.querys.join("/"));n("pushed ",h)}$(document).keyup(function(e){e.keyCode===27&&c();return!1});$(".btnBack:last").live("click",function(){c();return!1});return $("body").append('<script type="text/javascript" src="http://spreadsheets.google.com/feeds/cells/0AqR1sqwm6uPwdDJ3MGlfU0tDYzR5a1h0MXBObWhmdnc/od6/public/basic?alt=json-in-script&callback=window.handleExplanations"></script>')};document.createElementNS!=null&&document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect!=null?$(function(){return $("body").append('<script type="text/javascript" src="http://spreadsheets.google.com/feeds/cells/0AurnydTPSIgUdEd1V0tINEVIRHQ3dGNSeUpfaHY3Q3c/od6/public/basic?alt=json-in-script&callback=window.handleStories"></script>')}):$("#charts").hide()}).call(this);