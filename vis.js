// Generated by CoffeeScript 1.6.1
(function(){var e,t,n,r,i,s={}.hasOwnProperty,o=function(e,t){function r(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);r.prototype=t.prototype;e.prototype=new r;e.__super__=t.prototype;return e};i=function(e,t){var n,r,i,s,o,u,a;a="";n="";r="";if(e<0){n=" הכנסה של";r="";e=-e}if(e>=1e12){a=" trillion";e/=1e12;t=2}else if(e>=1e9){a=" מיליארד";e/=1e9;t=1}else if(e>=1e6){a=" מיליון";e/=1e6;t=1}s="";if(t>0){e<1&&(s="0");u=String(Math.round(e*Math.pow(10,t)));if(u<10){o="0"+u.substr(u.length-t,t);i=""}else{o=u.substr(u.length-t,t);i=u.substr(0,u.length-t)}return n+s+i.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")+"."+o+a+r}u=String(Math.round(e));u=u.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,");return n+u+a+r};t=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}o(t,e);t.prototype.defaults={data:[],field:""};t.prototype.initialize=function(){return this.on("change:field",function(){var e,t;t=this.get("field");e=budget_array_data[t];if(e){console.log("setting field "+t);return this.set("data",budget_array_data[t])}return console.log("field "+t+" is "+e)})};return t}(Backbone.Model);n=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}o(t,e);t.prototype.initialize=function(e){this.options=e;_.bindAll(this);return this.template=$(this.el).attr("data-template")};t.prototype.render=function(){};t.prototype.select=function(){return this.$(".btn").click()};t.prototype.events={"click .btn":function(e){var t;t=this.template;await(setTimeout(defer(_),10));this.$(".btn-toolbar").each(function(e){var n,r,i,s,o,u,a,f;n=$(this);a=["1","2"];f=[];for(o=0,u=a.length;o<u;o++){i=a[o];r=n.attr("data-field"+i);s=n.find(".btn.active:first").attr("data-value"+i);s||(s="");if(r){console.log(r,"-->",s);f.push(t=t.replace(new RegExp(r,"g"),s))}else f.push(void 0)}return f});return this.model.set("field",t)}};return t}(Backbone.View);e=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}o(n,e);n.prototype.initialize=function(e){var t;this.options=e;_.bindAll(this);console.log("BubbleChart:initialize",this.model);this.width=970;this.height=550;this.groupPadding=10;this.totalValue=(t=this.options.totalValue)!=null?t:4e8;console.log("totalValue !!! ",this.totalValue);this.defaultGravity=.1;this.defaultCharge=function(e){return e.value<0?0:-Math.pow(e.radius,2)/8};this.links=[];this.force={};this.svg={};this.circle={};this.gravity=null;this.charge=null;this.changeTickValues=[-0.25,-0.15,-0.05,.05,.15,.25];this.fillColor=d3.scale.ordinal().domain([-3,-2,-1,0,1,2,3]).range(["#ddad13","#eeca7c","#e4d0ae","#AAA","#bfc3dc","#9ea5c8","#7b82c2"]);this.strokeColor=d3.scale.ordinal().domain([-3,-2,-1,0,1,2,3]).range(["#c09100","#e7bd53","#d9c292","#999","#a7aed3","#7f8ab8","#4f5fb0"]);this.getFillColor=function(e){return e.isNegative?"#fff":this.fillColor(e.changeCategory)};this.getStrokeColor=function(e){return this.strokeColor(e.changeCategory)};this.pFormat=d3.format("+.1%");this.pctFormat=function(e){return e===Infinity||e===-Infinity?"N.A":this.pFormat(e)};this.tickChangeFormat=d3.format("+%");this.simpleFormat=d3.format(",");this.simpleDecimal=d3.format(",.2f");this.bigFormat=function(e){return i(e*1e3)};this.nameFormat=function(e){return e};this.rScale=d3.scale.pow().exponent(.5).domain([0,this.totalValue]).range([1,200]);this.radiusScale=function(e){return this.rScale(Math.abs(e))};this.changeScale=d3.scale.linear().domain([-0.28,.28]).range([620,180]).clamp(!0);this.sizeScale=d3.scale.linear().domain([0,110]).range([0,1]);this.categorizeChange=function(e){return isNaN(e)?0:e<-0.25?-3:e<-0.05?-2:e<-0.001?-1:e<=.001?0:e<=.05?1:e<=.25?2:3};this.totalSort=function(e){var t=this;return function(n){var r,i;i=0;r=0;n.isNegative&&(n.changeCategory>0?n.x=-200:n.x=1100);n.y=n.y+(i-n.y)*(t.defaultGravity+.02)*e;return n.x=n.x+(r-n.x)*(t.defaultGravity+.02)*e}};this.buoyancy=function(e){var t=this;return function(n){var r;r=-(n.changeCategory/3)*t.boundingRadius;return n.y=n.y+(r-n.y)*t.defaultGravity*e*e*e*500}};this.currentYearDataColumn="budget_1";this.previousYearDataColumn="budget_0";this.boundingRadius=this.radiusScale(this.totalValue);this.maxRadius=null;this.centerX=this.width/2;this.centerY=this.height/2;this.model.bind("change:data",this.updateData);d3.select(this.el).html("");this.svg=d3.select(this.el).append("svg:svg").attr("width",this.width);this.force=null;this.nodes=[];return console.log("init done")};n.prototype.updateData=function(){var e,t,n,r,i,s,o,u,a,f;n=this.nodes;this.nodes=[];f=this.model.get("data");for(s=0,u=f.length;s<u;s++){e=f[s];r=null;i=e.id;for(o=0,a=n.length;o<a;o++){t=n[o];t.sid===i&&(r=t)}r===null&&(r={x:-150+Math.random()*300,y:-150+Math.random()*300});r.sid=e.id;r.code=e.id;r.radius=this.radiusScale(e[this.currentYearDataColumn]);r.group=strings[e.p];r.groupvalue=e.pv;r.change=e.change/100;r.changeCategory=this.categorizeChange(e.change/100);r.value=e[this.currentYearDataColumn];r.name=strings[e.name];r.isNegative=e[this.currentYearDataColumn]<0;r.positions=e.positions;if(e[this.currentYearDataColumn]>0!=e[this.previousYearDataColumn]>0){r.change="N.A.";r.changeCategory=0}if(e.change===99999){r.change="N.A.";r.changeCategory=3}this.nodes.push(r)}return this.render()};n.prototype.showOverlay=function(e,r){var i,s,o,u,a,f,l;f=Number(r.attr("cx"));l=Number(r.attr("cy"));u=this.height/e.radius/3;console.log(e.radius,this.height,u);o="translate("+this.centerX+","+this.centerY+")rotate(0)translate(1,1)scale(1)";a="translate("+this.centerX+","+this.centerY+")rotate(120)translate("+ -f*u+","+ -l*u+")scale("+u+")";console.log("origin:",o);console.log("target:",a);$("#overlayContainer").css("display","block");this.svg.selectAll("circle").transition().duration(1e3).attrTween("transform",function(){return d3.interpolateString(o,a)});$("#overlayContainer div").css("opacity",0).stop(!0).animate({opacity:.9},1e3,function(){return $("#overlayContainer").css("display","block")});$("#overlayContainer #close").click(this.removeOverlay);$("#overlayContainer .name").html(""+e.group);$("#tooltip").hide();i=$("#overlayContainer .chart");s=new t;console.log("DDD",e.groupvalue);this.drilldown=new n({el:i,model:s,totalValue:e.groupvalue});return s.set("field",this.model.get("field")+"/"+e.code.slice(0,4))};n.prototype.removeOverlay=function(){var e,t;e=this.svg.select("circle").attr("transform");t="translate("+this.centerX+","+this.centerY+")rotate(0)translate(1,1)scale(1)";console.log("origin:",e);console.log("target:",t);this.svg.selectAll("circle").transition().duration(1e3).attrTween("transform",function(){return d3.interpolateString(e,t)});$("#overlayContainer div").stop(!0).animate({opacity:0},1e3,function(){return $("#overlayContainer").css("display","none")});this.drilldown.svg.selectAll("circle").transition().duration(1e3).attr("r",0).each("end",function(){return $("#overlayContainer svg").remove()});return $("#overlay #close").off("click")};n.prototype.render=function(){var e,t=this;this.circle=this.svg.selectAll("circle").data(this.nodes,function(e){return e.sid});e=this;this.circle.enter().append("svg:circle").attr("transform","translate("+this.centerX+","+this.centerY+")rotate(0)translate(1,1)scale(1)").style("stroke-width",1).style("fill",function(e){return t.getFillColor(e)}).style("stroke",function(e){return t.getStrokeColor(e)}).on("click",function(t,n){var r;r=d3.select(this);return e.showOverlay(t,r)}).on("mouseover",function(t,n){var r,i,s,o,u;console.log("mouseover");r=d3.select(this);s=$(e.el).find("svg").position();o=Number(r.attr("cx"))+s.left+e.centerX;u=r.attr("cy")-t.radius-10+s.top+e.centerY;console.log("tooltip ",o,u);r.style("stroke","#000").style("stroke-width",3);d3.select("#tooltip").style("top",u+"px").style("left",o+"px").style("display","block").classed("plus",t.changeCategory>0).classed("minus",t.changeCategory<0);d3.select("#tooltip .name").html(e.nameFormat(t.name));d3.select("#tooltip .department").text(t.group);d3.select("#tooltip .value").html(e.bigFormat(t.value)+" ₪");i=t.change==="N.A."?"N.A":e.pctFormat(t.change);d3.select("#tooltip .change").html(i);return console.log("mouseover out")}).on("mouseout",function(t,n){d3.select(this).style("stroke-width",1).style("stroke",function(t){return e.getStrokeColor(t)});return d3.select("#tooltip").style("display","none")});this.circle.transition().duration(1e3).attr("r",function(e){return e.radius}).style("fill",function(e){return t.getFillColor(e)}).style("stroke",function(e){return t.getStrokeColor(e)});this.circle.exit().transition().duration(1e3).attr("r",function(e){return 0}).remove();this.force!==null&&this.force.stop();return this.force=d3.layout.force().nodes(this.nodes).size([this.width,this.height]).gravity(-0.01).charge(this.defaultCharge).friction(.9).on("tick",function(e){return t.circle.each(t.totalSort(e.alpha)).each(t.buoyancy(e.alpha)).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y})}).start()};return n}(Backbone.View);r=function(r){var i,s,o;s=new t;i=new e({el:$("#"+r+" .chart"),model:s});o=new n({el:$("#"+r+" .selector"),model:s});return o.select()};document.createElementNS!=null&&document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect!=null?$(function(){$("#charts").carousel({interval:!1});r("TBFrame");r("TTFrame");return r("BBFrame")}):$("#charts").hide()}).call(this);